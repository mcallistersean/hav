version: '2'

services:

  hav_db:
    image: postgres
    hostname: ${HAV_DB_HOST}
    environment:
      - POSTGRES_PASSWORD=${HAV_DB_PW}
      - POSTGRES_USER=${HAV_DB_USER}
      - POSTGRES_DB=${HAV_DB_NAME}
    expose:
      - 5432
    volumes:
      - ./docker/mounts/db_dumps:/db_dumps:ro

  whav_db:
    image: mdillon/postgis:9.4
    hostname: ${WHAV_DB_HOST}
    environment:
      - POSTGRES_PASSWORD=${WHAV_DB_PW}
      - POSTGRES_USER=${WHAV_DB_USER}
      - POSTGRES_DB=${WHAV_DB_NAME}
    expose:
      - 5432
    volumes:
      - ./docker/mounts/db_dumps:/db_dumps:ro

  django:
    depends_on:
      - "hav_db"
      - "whav_db"
      - "frontend"
    extends:
      file: ./docker-compose/django.yml
      service: django
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./:/code
      - ./dist:/dist
      - ./frontend/build:/build
      - ./docker/mounts/incoming:/incoming
    expose:
      - 8000


  celery:
    extends:
      file: ./docker-compose/django.yml
      service: django
    command: celery -A hav worker -l info
    volumes:
      - ./:/code
      - ./dist:/dist
      - ./frontend/build:/build
      - ./docker/mounts/incoming:/incoming
    expose:
      - 8000

  caddy:
    build:
      context: .
      dockerfile: ./docker/caddy/Dockerfile
    ports:
      - 8000:80
    volumes:
      - ./docker/caddy/Caddyfile:/etc/Caddyfile

  frontend:
    build:
      context: .
      dockerfile: ./docker/frontend/Dockerfile
    expose:
      - 8000
    volumes:
      - ./frontend/:/code
    command: yarn run docker

  thumbor:
    image: apsl/thumbor:latest
    expose:
      - 8000
    volumes:
      - /data
      - ./dist/media:/data/loader
    environment:
      - LOADER=thumbor.loaders.file_loader_http_fallback
      - STORAGE=thumbor.storages.file_storage
      - AUTO_WEBP=True
      - FILE_STORAGE_ROOT_PATH=/data/storage
      - FILE_LOADER_ROOT_PATH=/data/loader
      - SECURITY_KEY=${THUMBOR_SECRET_KEY}
      - ALLOW_UNSAFE_URL=False

  redis:
    image: redis:alpine
    volumes:
      - ./docker/mounts/redis:/data

  imgproxy:
    image: darthsim/imgproxy
    ports:
      - 8081:8080
    environment:
      - IMGPROXY_KEY=d3a155089f0ae049e501cddab8ada7567398aa001b47f4e651187fbf1f378f4cb8e5e04ad48ed4834860d67062540ea36b6cede298df8e6ca720daa1142988d9
      - IMGPROXY_SALT=be0353dcf9f6c8f4d8769faf90b8283ea44573b477a3ed31c6c5b7b9704c6252f37f51ce16735f7ba0678905a1759d2ad8e2ffc6981ca89c78a7bcdd64599503
      - IMGPROXY_LOCAL_FILESYSTEM_ROOT=/srv  
    volumes:
      - ./dist/incoming:/srv/incoming
      - ./dist/archive:/srv/archive
      - ./dist/incoming:/test
      